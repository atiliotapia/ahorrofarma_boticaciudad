SET ECHO OFF
SET TALK OFF
DEFI WIND PEDII FROM 9,18 TO 16,55 SHADOW
DEFI WIND CENSO FROM 1,0 TO 24,79 TITLE 'RECORD DE EXONERACIONES SEGUN PERSONAL'
DEFI WIND TIPO FROM 9,25 TO 16,50 DOUBLE 
SET NEAR ON
FIN=DATE()
FFI=DATE()
CODASIS=SPACE(6)
NOMASIS=SPACE(10)
SELE A
     USE FACTURA ALIAS FACTURA NOUPDATE
     SET ORDE TO FECHA
SELE B
     USE ATENCTDO ALIAS ATENCTDO NOUPDATE
     SET ORDE TO REGISTRO
SELE C
     USE PACIENTE ALIAS PACIENTE NOUPDATE
     SET ORDE TO FECHA_EXON
SELE D
     USE SERVICIO ALIAS SERVICIO NOUPDATE
     SET ORDE TO CODIGO
SELE E
     USE USUARIOS.LIB ALIAS USUARIOS
     SET ORDE TO CODIGO
SELE A
ACTI WIND PEDII
@0,19 SAY '[ dd/mm/aaaa ]'
@5,2 SAY '  Fechas iguales para un d¡a  '
@1,4 SAY 'FECHA INICIAL:  ' GET FIN
@2,4 SAY 'FECHA FINAL  :  ' GET FFI
@3,4 SAY 'PERSONAL     :  ' GET CODASIS VALID VERIPERS(CODASIS) ERROR "TRABAJADOR NO REGISTRADO"
READ
IF LASTKEY()=27
   DEAC WIND PEDII
   RETURN
ENDIF   
DEAC WIND PEDII
SET SAFE OFF
SELE PACIENTE
SELECT CUENTA_C AS NUMERO,NOMBRE,SERVICIO,(LABORATORI+IMAGENES+ECOGRAFIA+OTROS_ATEN+M_MEDICO+B_MEDICINA+C_MEDICINA+T_SALA+HOSPITAL),MONTO_EXON,FECHA_EXON,HORA_EXON,DIGI_EXON,TIPO_PAC AS TIPO;
 FROM PACIENTE;
 INTO TABLE C:\SIGEP\TEMP\TMPOEXON;
 WHERE MONTO_EXON>0 AND FECHA_EXON>=FIN AND FECHA_EXON<=FFI AND DIGI_EXON=CODASIS
SET SAFE ON
SELE TMPOEXON
REPLA ALL TIPO WITH "H"
SET NEAR ON
SELE FACTURA
SEEK FIN
DO WHILE !EOF()
   IF FECHA>=FIN AND FECHA<=FFI
      IF TIPO="C"
         NUM=NUMERO
         SELE ATENCTDO
         SEEK NUM
         IF FOUN() AND EXONERAR>0 AND DIGI_EXON=CODASIS
 	        TOT=PREC_ATE1*CANTIDAD1+PREC_ATE2*CANTIDAD2+PREC_ATE3*CANTIDAD3+PREC_ATE4*CANTIDAD4+PREC_ATE5*CANTIDAD5
 	        SCATTER MEMVAR MEMO
 	        SELE TMPOEXON
 	        APPE BLAN
 	        REPLA NUMERO WITH M.REGISTRO, NOMBRE WITH M.NOMBRE, SERVICIO WITH M.SERVICIO, EXP_4 WITH TOT, MONTO_EXON WITH EXONERAR, FECHA_EXON WITH M.FECHA, HORA_EXON WITH M.HORA, DIGI_EXON WITH M.DIGI_EXON, TIPO WITH "A"
         ENDIF
      ENDIF
     ELSE
      EXIT
   ENDIF
   SELE FACTURA
   SKIP
ENDDO
SET NEAR OFF
SET SAFE OFF
SELE TMPOEXON
INDE ON FECHA_EXON TAG FECHA_EXON
SET SAFE ON
WAIT WIND "CONCLUIDO" TIME 0.1
ACTI WIND CENSO
@0,0 SAY "PERIODO :> "+DTOC(FIN)+"-"+DTOC(FFI) COLO G+/B
@0,48 SAY "ASISTENTA: "+NOMASIS COLO G/B
@1,0 SAY 'REGISTRO              PACIENTE            FECHA     TOTAL  EXONERAD  DIGITAD' COLO GR+/B
@2,0 SAY REPL('Í',78) COLO GR+/B
Y=3
TOTP=0
TOTT=0
TOTE=0
SELE TMPOEXON
GO TOP
DO WHILE !EOF()
   @Y,1 SAY +STR(NUMERO,6)+' '+SUBS(NOMBRE,1,30)+' '+DTOC(FECHA_EXON)+' '+STR(EXP_4,8,2)+' '+STR(MONTO_EXON,8,2)+'  '+DIGI_EXON+' '+TIPO
   Y=Y+1
   TOTP=TOTP+1
   TOTT=TOTT+EXP_4
   TOTE=TOTE+MONTO_EXON
   IF Y=20
      READ
      IF LASTKEY()=27
         DEAC WIND CENSO
         RETURN
	  ENDIF   
      Y=3
      @3,0 CLEA TO 20,78
   ENDIF  
   SKIP
ENDDO
@20,0 SAY 'TOTALES -> '+STR(TOTP,5)+' Pacientes       CUENTA S/.'+STR(TOTT,9,2)+'    EXONERADO S/.'+STR(TOTE,9,2) COLO G/B
@21,0 SAY REPL('Û',78) COLO RB/B
@21,10 SAY 'F8-Imprime' COLO W/RB
@21,64 SAY 'ESC-Salir' COLO W/RB
@21,10 SAY 'F8' COLO GR+/RB
@21,64 SAY 'ESC' COLO GR+/RB
ON KEY LABEL F8 DO IMPRIME
SET ESCAPE ON
STORE .F. TO mexit
ON ESCAPE STORE .T. TO mexit
DO WHILE NOT mexit
   IF LASTKEY()!=-1 .AND. LASTKEY()!=-4
      CLEAR TYPEAHEAD
   ENDIF   
ENDDO
ON KEY LABEL F8
DEAC WIND CENSO
CLOS ALL
SET NEAR OFF
RETURN


FUNCTION VERIPERS
PARAMETER A
SELE USUARIOS
SEEK A
IF FOUN()
   NOMASIS=SUBS(NOMBRE,1,8)+" "+SUBS(A_PATERNO,1,8)+" "+SUBS(A_MATERNO,1,8)
   WAIT WIND ""+NOMASIS NOWA
   RETURN .T.
  ELSE
   RETURN .F.
ENDIF


FUNCTION FECHAS
PARAMETER FEC
FEC=CTOD(FEC)
IF DTOC(FEC)!='  /  /  '
   RETURN .T.
  ELSE
   RETURN .F. 
ENDIF

PROCEDURE IMPRIME
		SET DEVI TO PRINT
		@0,0 SAY CHR(15)
		Y=8
		X=0
		MONTEXON=0
		PG=1
		@1,26 SAY 'EXONERACIONES PACIENTES HOSPITALIZADOS  '+TITULO01
		@2,3 SAY 'PERIODO:> '+DTOC(FIN)+' - '+DTOC(FFI)
        @4,1 SAY "ASISTENTA: "+NOMASIS COLO G/B
   		@4,134 SAY 'Pg. '+STR(PG,2)
		@5,0 SAY +REPLI('ð',116)
        @6,0 SAY '  TIPO   BOLETA   CTA.CTE.             PACIENTE                     SERVICIO        FECHA     TOTAL S/.  MONTO EXON'
		@7,0 SAY +REPLI('ð',116)
		Y=8
		SELE TMPOEXON
		GO TOP
	   	DO WHILE !EOF()
		   SER=SERVICIO
		   SELE SERVICIO
		   SEEK SER
		   SERVIC=NOMBRE
		   SELE TMPOEXON
              IF TIPO="A"
                 @Y,1 SAY 'AMB.  '+STR(NUMERO,8)+'               '+SUBS(NOMBRE,1,30)+'   '+SUBS(SERVIC,1,15)+'   '+DTOC(FECHA_EXON)+'   '+STR(EXP_4,8,2)+'   '+STR(MONTO_EXON,8,2)
                ELSE
                 @Y,1 SAY 'HOSP. '+'           '+STR(NUMERO,8)+'    '+SUBS(NOMBRE,1,30)+'   '+SUBS(SERVIC,1,15)+'   '+DTOC(FECHA_EXON)+'   '+STR(EXP_4,8,2)+'   '+STR(MONTO_EXON,8,2)
              ENDIF
		      Y=Y+1
		      X=X+1
		      MONTEXON=MONTEXON+MONTO_EXON
	          IF Y=55
   	        	 EJECT
		         PG=PG+1
		         @1,26 SAY 'EXONERACIONES PACIENTES HOSPITALIZADOS  '+TITULO01
		         @2,3 SAY 'PERIODO:> '+DTOC(FIN)+' - '+DTOC(FFI)
                 @4,1 SAY "ASISTENTA: "+NOMASIS COLO G/B
   		         @4,134 SAY 'Pg. '+STR(PG,2)
		         @5,0 SAY +REPLI('ð',116)
                 @6,0 SAY '  TIPO   BOLETA   CTA.CTE.             PACIENTE                     SERVICIO        FECHA     TOTAL S/.  MONTO EXON'
      		     @7,0 SAY +REPLI('ð',116)
	   	         Y=8
	   	         IF LASTKEY()=27
	   			    EJECT
		            SET DEVI TO SCREE
    		        EXIT
                 ENDIF
        	  ENDIF   
		   SKIP
		ENDDO
		@56,0 SAY +REPLI('-',116)
		@57,1 SAY 'TOTALES -> '+STR(TOTP,5)+' Pacientes                   CUENTA S/.'+STR(TOTT,9,2)+'                EXONERADO S/.'+STR(TOTE,9,2)
		@58,0 SAY +REPLI('-',116)
        EJECT
		SET DEVI TO SCRE
